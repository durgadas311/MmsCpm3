		********** CP/M LINKABLE BOOT ROUTINE **********
		**********			      **********
3131          	VERS	EQU	'11'		; AUGUST 10, 1982 10:11 KLF "B320.ASM
		************************************************
		****  MACRO ASSEMBLER DIRECTIVES  **************
			MACLIB	Z80
**** Z80.lib ****
**** b320.asm ****
			$-MACRO
		
0000  0001FFFF		DW	MODLEN,(-1)
		
0000          	BASE	EQU	0000H	;ORG FOR RELOC
		
		***** PHYSICAL DRIVES ARE ASSIGNED AS FOLLOWS *****
		*****					      *****
		*****					      *****
		***************************************************
		
		***************************************************
		**  PORTS AND CONSTANTS
		***************************************************
00F2          	?PORT	EQU	0F2H
		
		** Serial I/O ports on 88-3 board
00D0          	?AUX		EQU	0D0H	;DCE
00E0          	?PRINTER	EQU	0E0H	;LP/DCE
00D8          	?MODEM		EQU	0D8H	;DTE
		
0003          	?LINE$CTL	EQU	00000011B	;NO PARITY, 1 STOP BIT, 8 DATA BITS
000F          	?MOD$CTL	EQU	00001111B	;SET ALL CONTROL LINES TO 'READY'
		
2150          	BASE$PORT EQU	2150H		; PORT ADDRESS SAVE BY BOOT PROM
		
0006          	?S19200 EQU	6	; 19,200 BAUD
000C          	?S9600	EQU	12	;  9,600 BAUD
0018          	?S4800	EQU	24	;  4,800 BAUD
0030          	?S2400	EQU	48	;  2,400 BAUD
0060          	?S1200	EQU	96	;  1,200 BAUD
00C0          	?S600	EQU	192	;    600 BAUD
0180          	?S300	EQU	384	;    300 BAUD
0300          	?S150	EQU	768	;    150 BAUD
0417          	?S110	EQU	1047	;    110 BAUD
		
0078          	DAT	EQU	78H
0079          	CONT	EQU	79H
		
0080          	REQ	EQU	10000000B
0040          	POUT	EQU	01000000B
0020          	MSG	EQU	00100000B
0010          	CMND	EQU	00010000B
0008          	BUSY	EQU	00001000B
		
0000          	RUN	EQU	00000000B
0010          	SWRS	EQU	00010000B
0040          	SEL	EQU	01000000B
		
2483          	BLCODE	EQU	2483H	; DEBLOCK CODE
2484          	LSP	EQU	2484H	; LOGICAL SECTORS PER PHYSICAL
					; (PASSED BY BOOT LOADER)
		***************************************************
		
		***************************************************
		** LINKS TO REST OF SYSTEM
		***************************************************
1600          	@BIOS	EQU	BASE+1600H
0800          	@BDOS	EQU	@BIOS-0E00H
		***************************************************
		
		***************************************************
		** PAGE ZERO ASSIGNMENTS
		***************************************************
0000          		ORG	0
0000          	?CPM		DS	3
0003          	?DEV$STAT	DS	1
0004          	?LOGIN$DSK	DS	1
0005          	?BDOS		DS	3
0008          	?RST1		DS	3
000B          	?CLOCK		DS	2
000D          	?INT$BYTE	DS	1
000E          	?CTL$BYTE	DS	1
000F          			DS	77
005C          	?FCB		DS	36
0080          	?DMA		DS	128
		?TPA		DS	0
		***************************************************
		
		***************************************************
		** START OF RELOCATABLE DISK BOOT MODULE
		*************************************************** 
2280          		ORG	2280H
2280          	BOOT:
2280  C38522  		JMP	AROUND
2283  00      	SECTRS	DB	0	;NUMBER OF SECTORS TO BOOT, FROM MOVCPM.COM
						; PATCHED DURING EXECUTION OF MOVCPM
2284  00      	DRIVE	DB	0		; ALSO PATCHED BY ASSIGN PROGRAM
2285  218322  	AROUND: LXI	H,SECTRS
2288  34      		INR	M
2289  34      		INR	M		; TWO MORE SECTORS (BOOT MODULE)
228A  3A8324  		LDA	BLCODE
228D  B7      		ORA	A
228E  56      		MOV	D,M
228F  280B    		JRZ	NODIV		; NO MORE TO DO IF SECTOR SIZE = 128
2291  47      		MOV	B,A
2292  3A8424  		LDA	LSP
2295  3D      		DCR	A		; ADD THIS QUANTITY FOR ROUNDING UP
2296  86      		ADD	M
2297  B7      	AGN1:	ORA	A		; TO CLEAR CARRY
2298  1F      		RAR
2299  10FC    		DJNZ	AGN1
229B  57      		MOV	D,A		; PHYSICAL SECTORS TO BE BOOTED
229C  217A23  	NODIV:	LXI	H,CMBFR+4
229F  72      		MOV	M,D
22A0  3A5021  	LOAD:	LDA	BASE$PORT
22A3  4F      		MOV	C,A
22A4  0C      		INR	C		; CONTROL PORT TO REG. C
		
22A5  0600    	GETCON: MVI	B,0
22A7  ED78    	GETCN1: INP	A
22A9  E608    		ANI	BUSY
22AB  2803    		JRZ	GETCN2
22AD  10F8    		DJNZ	GETCN1
22AF  C9      		RET
22B0  3E40    	GETCN2: MVI	A,SEL
22B2  ED79    		OUTP	A
22B4  0600    		MVI	B,0
22B6  ED78    	GETCN3: INP	A
22B8  E608    		ANI	BUSY
22BA  2003    		JRNZ	GETCN4
22BC  10F8    		DJNZ	GETCN3
22BE  C9      		RET
22BF  3E00    	GETCN4: MVI	A,RUN
22C1  ED79    		OUTP	A
		
22C3  0D      		DCR	C		; DATA PORT BACK TO REG. C
		
22C4  217623  	OUTCOM: LXI	H,CMBFR 	; OUTPUT THE COMMAND
22C7  0606    		MVI	B,6
22C9  C5      	OUTCM1: PUSH	B
22CA  0C      	OUTLOP: INR	C		; CONTROL PORT
22CB  ED78    		INP	A
22CD  E6D8    		ANI	(REQ OR CMND OR POUT OR BUSY)
22CF  FED8    		CPI	(REQ OR CMND OR POUT OR BUSY)
22D1  2803    		JRZ	OUTOK
22D3  10F5    		DJNZ	OUTLOP
22D5  C9      		RET
22D6  C1      	OUTOK:	POP	B
22D7  EDA3    		OUTI
22D9  C2C922  		JNZ	OUTCM1
		
22DC  210007  	SASI$RW:LXI	H,@BDOS-100H	; READ IN SECTORS STARTING AT THIS ADDRESS
22DF  0C      	NXTSEC: INR	C		; CONTROL PORT
22E0  ED78    	SASICK: INP	A
22E2  E6D8    		ANI	(CMND OR BUSY OR REQ OR POUT)
22E4  FE98    		CPI	(CMND OR BUSY OR REQ)	; IF POUT DROPS,
22E6  2816    		JRZ	CHK$STAT		; WE ARE INTO STATUS PHASE
22E8  E698    		ANI	(CMND OR BUSY OR REQ)
22EA  FE88    		CPI	(BUSY OR REQ)	; WHEN CMND DROPS, SEEK IS COMPLETE, AND
22EC  20F2    		JRNZ	SASICK		;  WE ARE READY TO READ IN A SECTOR
22EE  0D      		DCR	C		; DATA PORT
22EF  3A8424  		LDA	LSP 
22F2  0680    	MORE:	MVI	B,128
22F4  EDB2    		INIR
22F6  3D      		DCR	A
22F7  20F9    		JRNZ	MORE
22F9  3D      	WAIT:	DCR	A
22FA  20FD    		JRNZ	WAIT
22FC  18E1    		JR	NXTSEC		; SEE IF THER'S ANOTHER SECTOR TO READ IN
		
22FE          	CHK$STAT:			; CHECK STATUS OF READ
22FE  217C23  		LXI	H,STAT
2301  1804    		JR	CHK02
2303  ED78    	CHKNXT: INP	A
2305  77      		MOV	M,A
2306  0C      	CHK01:	INR	C		; CONTROL PORT
2307  ED78    	CHK02:	INP	A		; INPUT FROM CONTROL PORT
2309  0D      		DCR	C		; DATA PORT
230A  E6F0    		ANI	(MSG OR REQ OR CMND OR POUT)
230C  FE90    		CPI	(REQ OR CMND)
230E  28F3    		JRZ	CHKNXT
2310  FEB0    		CPI	(MSG OR REQ OR CMND)
2312  20F2    		JRNZ	CHK01
2314  ED78    		INP	A
2316  7E      		MOV	A,M
2317  E603    		ANI	3
2319  C0      		RNZ
		
		
		***************************************************
		** START OF SYSTEM INITIALIZATION
		*************************************************** 
231A  F3      	START:	DI
		* INITIALIZE I/O, ETC
231B  AF      		XRA	A
231C  D3D4    		OUT	?AUX+4
231E  D3E4    		OUT	?PRINTER+4
2320  D3DC    		OUT	?MODEM+4
2322  3E03    		MVI	A,?LINE$CTL
2324  F680    		ORI	10000000B	;ENABLE DIVISOR LATCH
2326  D3D3    		OUT	?AUX+3
2328  D3E3    		OUT	?PRINTER+3
232A  D3DB    		OUT	?MODEM+3
		* BAUD RATE SETUP:
232C  210C00  		LXI	H,?S9600	;AUX SERIAL @ 9600 BAUD
232F  7D      		MOV	A,L
2330  D3D0    		OUT	?AUX
2332  7C      		MOV	A,H
2333  D3D1    		OUT	?AUX+1
2335  210C00  		LXI	H,?S9600	; PRINTER @ 9600 BAUD
2338  7D      		MOV	A,L
2339  D3E0    		OUT	?PRINTER
233B  7C      		MOV	A,H
233C  D3E1    		OUT	?PRINTER+1
233E  218001  		LXI	H,?S300 	; MODEM (PAPER TAPE) @ 300 BAUD
2341  7D      		MOV	A,L
2342  D3D8    		OUT	?MODEM
2344  7C      		MOV	A,H
2345  D3D9    		OUT	?MODEM+1
		* NOW GET PORTS READY FOR I/O
2347  3E03    		MVI	A,?LINE$CTL	; NOW DE-SELECT DIVISOR LATCH
2349  D3D3    		OUT	?AUX+3
234B  D3E3    		OUT	?PRINTER+3
234D  D3DB    		OUT	?MODEM+3
234F  3E0F    		MVI	A,?MOD$CTL	; SIGNAL 'READY'
2351  D3D4    		OUT	?AUX+4
2353  D3E4    		OUT	?PRINTER+4
2355  D3DC    		OUT	?MODEM+4
2357  DBD5    		IN	?AUX+5		; RESET ANY STRAY ACTIVITY
2359  DBE5    		IN	?PRINTER+5
235B  DBDD    		IN	?MODEM+5
235D  DBD0    		IN	?AUX
235F  DBE0    		IN	?PRINTER
2361  DBD8    		IN	?MODEM
		* END OF I/O INITIALIZATION
2363  216F23  		LXI	H,?CODE ;SEQUENCE TO MOVE MEMORY-MAP
2366  0607    		MVI	B,?CODE$LEN	;NUMBER OF BYTES IN SEQUENCE
2368  0EF2    		MVI	C,?PORT ;I/O PORT TO SEND SEQUENCE
236A  EDB3    		DW 0B3EDH ; OUTIR
236C  C30016  		JMP	@BIOS
236F  04      	?CODE	DB	0000$01$00B
2370  0C      		DB	0000$11$00B
2371  04      		DB	0000$01$00B
2372  08      		DB	0000$10$00B
2373  0C      		DB	0000$11$00B
2374  08      		DB	0000$10$00B
2375  22      		DB	0010$00$10B	;changes memory if "-FA" also
0007          	?CODE$LEN	EQU	$-?CODE
2376  08000000	CMBFR:	DB	8,0,0,0,0,1
      0001
237C  00      	STAT:	DB	0
		
237D  0000    		REPT	256-($-BOOT)-1
		
237F  0B      	ID	DB	11	;BOOT ROUTINE IDENTIFICATION
0100          	MODLEN	EQU	$-BOOT	;MUST BE 256 BYTES
		
2380  00000000	 DB 00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B
      00000000
2388  00000002	 DB 00000000B,00000000B,00000000B,00000010B,00000000B,00000000B,00000000B,00000000B
      00000000
2390  00000000	 DB 00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B
      00000000
2398  00000000	 DB 00000000B,00000000B,00000000B,00000000B,00000000B,00000010B,00000000B,00000000B
      00020000
		
23A0          		END



Statistics:

     4	passes
     0	jr promotions
    80	symbols
   292	bytes

    61	macro calls
  3756	macro bytes
     0	invented symbols
