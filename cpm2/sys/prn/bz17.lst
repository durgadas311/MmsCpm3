		;  July 1, 1982  15:08	drm  "BZ17.ASM version 2.240"
		********** CP/M LINKABLE BOOT ROUTINE **********
		**********	   Z17 BOOT	      **********
0000  0001FFFF		DW	MODLEN,(-1)
		
0000          	BASE	EQU	0000H	;ORG FOR RELOC
		
		***** PHYSICAL DRIVES ARE ASSIGNED AS FOLLOWS *****
		*****					      *****
		*****  0 = FIRST (BUILT-IN) MINI FLOPPY       *****
		*****  1 = SECOND (ADD-ON) MINI FLOPPY	      *****
		*****  2 = THIRD (LAST ADD-ON) MINI FLOPPY    *****
		*****					      *****
		***************************************************
		
			MACLIB	Z80
**** Z80.lib ****
**** bz17.asm ****
		***************************************************
		**  PORTS AND CONSTANTS
		***************************************************
00F2          	?PORT	EQU	0F2H
		
00D0          	?AUX	EQU	0D0H
00E0          	?PRINTER	EQU	0E0H
00D8          	?MODEM	EQU	0D8H
		
0003          	?LINE$CTL	EQU	00000011B	;NO PARITY, 1 STOP BIT, 8 DATA BITS
000F          	?MOD$CTL	EQU	00001111B	;SET ALL CONTROL LINES TO 'READY'
		
0006          	?S19200 EQU	6	; 19,200 BAUD
000C          	?S9600	EQU	12	;  9,600 BAUD
0018          	?S4800	EQU	24	;  4,800 BAUD
0030          	?S2400	EQU	48	;  2,400 BAUD
0060          	?S1200	EQU	96	;  1,200 BAUD
00C0          	?S600	EQU	192	;    600 BAUD
0180          	?S300	EQU	384	;    300 BAUD
0300          	?S150	EQU	768	;    150 BAUD
0417          	?S110	EQU	1047	;    110 BAUD
		
0000          	VRST0	EQU	0000H	;RESTART PROM MONITOR
205E          	R@XOK	EQU	205EH	;TURN OFF Z17
2067          	R@READ	EQU	2067H	;ENTRY TO 444-19 ROM FOR READ DISK
2076          	R@SDT	EQU	2076H	;SEEK DESIRED TRACK (IN "R@TT")
2079          	R@MAI	EQU	2079H	;MOVE ARM IN (STEP IN)
207C          	R@MAO	EQU	207CH	;MOVE ARM OUT (STEP OUT)
2082          	R@RDB	EQU	2082H	;READ NEXT BYTE FROM DISK
2085          	R@SDP	EQU	2085H	;SELECT Z17 DRIVE (DELAY IF NEEDED)
2088          	R@STS	EQU	2088H	;SKIP-THIS-SECTOR (WAIT FOR SECTOR HOLE)
208B          	R@STZ	EQU	208BH	;SEEK TRACK ZERO
2091          	R@WSC	EQU	2091H	;WAIT FOR SYNC CHARACTER
		
20A0          	D@TT	EQU	20A0H	;LOCATION FOR DESTINATION TRACK (SEEK)
20A5          	D@TRKPT EQU	20A5H	;ADDRESS TO ACTUAL CURRENT TRACK
		***************************************************
		
		***************************************************
		** LINKS TO REST OF SYSTEM
		***************************************************
1600          	@BIOS	EQU	BASE+1600H
0800          	@BDOS	EQU	@BIOS-0E00H
		***************************************************
		
		***************************************************
		** PAGE ZERO ASSIGNMENTS
		***************************************************
0000          		ORG	0
0000          	?CPM		DS	3
0003          	?DEV$STAT	DS	1
0004          	?LOGIN$DSK	DS	1
0005          	?BDOS		DS	3
0008          	?RST1		DS	3
000B          	?CLOCK		DS	2
000D          	?INT$BYTE	DS	1
000E          	?CTL$BYTE	DS	1
000F          			DS	77
005C          	?FCB		DS	36
0080          	?DMA		DS	128
		?TPA		DS	0
		***************************************************
		
		***************************************************
		** START OF RELOCATABLE DISK BOOT MODULE
		*************************************************** 
2280          		ORG	2280H
2280          	BOOT:
2280  C38522  		JMP	AROUND
2283  00      	SECTRS	DB	0	;NUMBER OF SECTORS TO BOOT, FROM MOVCPM.COM
					;PATCHED DURING EXECUTION OF MOVCPM
2284  00      	DRIVE	DB	0	;DRIVE NUMBER PATCHED BY SETUP AND MOVCPM
		
2285  310024  	AROUND	LXI	SP,?STACK
		***************************************************
		*** START OF UNIQUE ROUTINE FOR BOOTING
		***************************************************
2288  110008  		LXI	D,@BDOS ;ADDRESS TO LOAD INTO
228B  214A23  		LXI	H,U@SDT
228E  227720  		SHLD	R@SDT+1 ;CHANGE ROM'S SEEK ROUTINE TO OURS
2291  210100  		LXI	H,0001H ;DISK ADDRESS OF FIRST SECTOR (0-399)
2294  3A8322  		LDA	SECTRS	;NUMBER OF SECTORS TO READ
2297  C601    		ADI	1	;ROUND UP TO NEXT 256 BYTE SECTOR
2299  CB3F    		SRLR	A
229B  47      		MOV	B,A
229C  0E09    		MVI	C,9	;9 SECTORS LEFT IN THIS TRACK (TRACK 0)
229E  AF      	DNTRK:	XRA	A
229F  325F23  		STA	HT$FLAG
22A2  E5      	DOTRK:	PUSH	H
22A3  D5      		PUSH	D
22A4  C5      		PUSH	B
22A5  010001  		LXI	B,0100H ;ONE SECTOR READ AT A TIME
22A8  CD6720  		CALL	R@READ	;READ A SECTOR
22AB  DAC722  		JC	ERR00
22AE  C1      		POP	B
22AF  D1      		POP	D
22B0  E1      		POP	H
22B1  14      		INR	D	;STEP DMA ADDRESS 256 BYTES
22B2  23      		INX	H	;POINT TO NEXT SECTOR
22B3  05      		DCR	B	;NO MORE SECTORS TO READ??
22B4  CAEA22  		JZ	DONE
22B7  0D      		DCR	C	;MORE SECTORS ON THIS TRACK??
22B8  C2A222  		JNZ	DOTRK
22BB  0E0A    		MVI	C,10
22BD  3A5E23  		LDA	TRK
22C0  3C      		INR	A
22C1  325E23  		STA	TRK
22C4  C39E22  		JMP	DNTRK
		
22C7  C1      	ERR00:	POP	B
22C8  79      		MOV	A,C
22C9  FE0A    		CPI	10
22CB  C20000  		JNZ	VRST0	;THIS TEST ONLY VALID IF ERROR ON 1ST SECTOR OF TRACK
22CE  3A5F23  		LDA	HT$FLAG ;THIS CAN ANLY OCCURE ONCE PER REQUESTED TRACK
22D1  B7      		ORA	A
22D2  C20000  		JNZ	VRST0
22D5  2F      		CMA
22D6  325F23  		STA	HT$FLAG
22D9  C5      		PUSH	B
22DA  CD8520  		CALL	R@SDP	;SELECT DRIVE
22DD  CD7920  		CALL	R@MAI	;STEP HEAD IN ONE TRACK
22E0  215E23  		LXI	H,TRK
22E3  34      		INR	M
22E4  C1      		POP	B
22E5  D1      		POP	D
22E6  E1      		POP	H
22E7  C3A222  		JMP	DOTRK
		
22EA          	DONE:
		***************************************************
		** START OF SYSTEM INITIALIZATION
		*************************************************** 
22EA  F3      		DI
		* INITIALIZE I/O, ETC
22EB  AF      		XRA	A
22EC  D3D4    		OUT	?AUX+4
22EE  D3E4    		OUT	?PRINTER+4
22F0  D3DC    		OUT	?MODEM+4
22F2  3E03    		MVI	A,?LINE$CTL
22F4  F680    		ORI	10000000B	;ENABLE DIVISOR LATCH
22F6  D3D3    		OUT	?AUX+3
22F8  D3E3    		OUT	?PRINTER+3
22FA  D3DB    		OUT	?MODEM+3
		* BAUD RATE SETUP:
22FC  210C00  		LXI	H,?S9600	;AUX SERIAL @ 9600 BAUD
22FF  7D      		MOV	A,L
2300  D3D0    		OUT	?AUX
2302  7C      		MOV	A,H
2303  D3D1    		OUT	?AUX+1
2305  210C00  		LXI	H,?S9600	;PRINTER @ 9600 BAUD
2308  7D      		MOV	A,L
2309  D3E0    		OUT	?PRINTER
230B  7C      		MOV	A,H
230C  D3E1    		OUT	?PRINTER+1
230E  218001  		LXI	H,?S300 ;MODEM (PAPER TAPE) @ 300 BAUD
2311  7D      		MOV	A,L
2312  D3D8    		OUT	?MODEM
2314  7C      		MOV	A,H
2315  D3D9    		OUT	?MODEM+1
		* NOW GET PORTS READY FOR I/O
2317  3E03    		MVI	A,?LINE$CTL	;NOW DE-SELECT DIVISOR LATCH
2319  D3D3    		OUT	?AUX+3
231B  D3E3    		OUT	?PRINTER+3
231D  D3DB    		OUT	?MODEM+3
231F  3E0F    		MVI	A,?MOD$CTL	;SIGNAL 'READY'
2321  D3D4    		OUT	?AUX+4
2323  D3E4    		OUT	?PRINTER+4
2325  D3DC    		OUT	?MODEM+4
2327  DBD5    		IN	?AUX+5	;RESET ANY STRAY ACTIVITY
2329  DBE5    		IN	?PRINTER+5
232B  DBDD    		IN	?MODEM+5
232D  DBD0    		IN	?AUX
232F  DBE0    		IN	?PRINTER
2331  DBD8    		IN	?MODEM
		* END OF I/O INITIALIZATION
2333  213F23  		LXI	H,?CODE ;SEQUENCE TO MOVE MEMORY-MAP
2336  0607    		MVI	B,?CODE$LEN	;NUMBER OF BYTES IN SEQUENCE
2338  0EF2    		MVI	C,?PORT ;I/O PORT TO SEND SEQUENCE
233A  EDB3    		OUTIR
233C  C30016  		JMP	@BIOS
233F  04      	?CODE	DB	0000$01$00B
2340  0C      		DB	0000$11$00B
2341  04      		DB	0000$01$00B
2342  08      		DB	0000$10$00B
2343  0C      		DB	0000$11$00B
2344  08      		DB	0000$10$00B
2345  22      		DB	0010$00$10B	;ALSO WORKS IN Z89-FA
0007          	?CODE$LEN	EQU	$-?CODE
		
		; OUR OWN SEEK ROUTINE THAT USES OUR TRACK NUMBER (ALLOWS HALF-TRACK)
2346  34      	SDT3:	INR	M
2347  CD7920  		CALL	R@MAI
234A  2AA520  	U@SDT:	LHLD	D@TRKPT
234D  3A5E23  		LDA	TRK
2350  BE      		CMP	M
2351  CA8820  		JZ	R@STS
2354  F24623  		JP	SDT3
2357  35      	SDT1:	DCR	M
2358  CD7C20  		CALL	R@MAO
235B  C34A23  		JMP	U@SDT
		
235E  00      	TRK:	DB	0	;OUR CURRENT PHYSICAL TRACK NUMBER
235F  00      	HT$FLAG DB	0	;USED TO KEEP TRACK OF HALF-TRACK DETECTION
		
0000          	 IF $ GT 2380H-1
		 ELSE
2360  00000000		REPT	2380H-$-1
      00000000
      00000000
      00000000
      00000000
      00000000
      00000000
      000000
		 ENDIF
		
237F  01      		DB	1	;BOOT IDENTIFICATION
0100          	MODLEN	EQU	$-BOOT	;MUST BE 256 BYTES
2400          	?STACK	EQU	$+128
		
2380  00200000	 DB 00000000B,00100000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B
      00000000
2388  00000000	 DB 00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B
      00000000
2390  00000000	 DB 00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000010B
      00000002
2398  00000000	 DB 00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B,00000000B
      00000000
23A0          		END



Statistics:

     4	passes
     0	jr promotions
    64	symbols
   292	bytes

    33	macro calls
  3756	macro bytes
     0	invented symbols
