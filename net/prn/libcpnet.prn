                ; Basic CP/NET routines
                
                	public	cpnsetup
                
                	maclib	z80
                
 0005 =         bdos	equ	5
                
 0009 =         print	equ	9
                
 000D =         cr	equ	13
 000A =         lf	equ	10
                
                	cseg
                
                ; HL=network config table
                ; DE=template (0FFH=skip)
                ; Reports any valid settings, assumes starting on newline
                cpnsetup:
 0000 0610      	mvi	b,16	; 16 drives
 0002 23        cpns0:	inx	h	; skip status/node ID
 0003 23        	inx	h
 0004 13        	inx	d
 0005 13        	inx	d
 0006 1A        	ldax	d	;
 0007 FEFF      	cpi	0ffh
 0009 C44B00    	cnz	netdrv
                	djnz	cpns0
 000C+10F4      	DB	10H,CPNS0-$-1
                	; drives done, skip CON:
 000E 23        	inx	h
 000F 23        	inx	h
 0010 13        	inx	d
 0011 13        	inx	d
                	; check LST:
 0012 1A        	ldax	d
 0013 FEFF      	cpi	0ffh
 0015 C8        	rz
 0016 77        	mov	m,a
 0017 320000    	sta	b0
 001A 23        	inx	h
 001B 13        	inx	d
 001C 1A        	ldax	d
 001D 77        	mov	m,a
 001E 320100    	sta	b1
 0021 3A0000    	lda	b0
 0024 E680      	ani	080h
                	jrz	loclst
 0026+281A      	DB	28H,LOCLST-$-1
                	; networked LST:
 0028 E60F      	ani	0fh
 002A 213F00    	lxi	h,nl1
 002D CD9E00    	call	hexdig
 0030 3A0100    	lda	b1
 0033 214100    	lxi	h,nl2
 0036 CD9500    	call	hexout
 0039 113000    	lxi	d,nlst
 003C 0E09      	mvi	c,print
 003E CD0500    	call	bdos
 0041 C9        	ret
 0042 112300    loclst:	lxi	d,llst
 0045 0E09      	mvi	c,print
 0047 CD0500    	call	bdos
 004A C9        	ret
                
 004B E5        netdrv:	push	h
 004C D5        	push	d
 004D 1A        	ldax	d
 004E 77        	mov	m,a
 004F 320000    	sta	b0
 0052 23        	inx	h
 0053 13        	inx	d
 0054 1A        	ldax	d
 0055 77        	mov	m,a
 0056 320100    	sta	b1
                	; report drive setting
 0059 C5        	push	b
 005A 3E10      	mvi	a,16
 005C 90        	sub	b	; local drive number
 005D C641      	adi	'A'
 005F 321500    	sta	n0
 0062 320800    	sta	l0
 0065 3A0000    	lda	b0
 0068 E680      	ani	080h
                	jrz	locdrv
 006A+281D      	DB	28H,LOCDRV-$-1
                ; networked drive
 006C 3A0000    	lda	b0
 006F E60F      	ani	0fh
 0071 C641      	adi	'A'
 0073 321A00    	sta	n1
 0076 3A0100    	lda	b1
 0079 211D00    	lxi	h,n2
 007C CD9500    	call	hexout
 007F 110D00    	lxi	d,netwk
 0082 0E09      	mvi	c,print
 0084 CD0500    	call	bdos
                	jr	retdrv
 0087+1808      	DB	18H,RETDRV-$-1
                
 0089 110200    locdrv:	lxi	d,ldrv
 008C 0E09      	mvi	c,print
 008E CD0500    	call	bdos
                retdrv:
 0091 C1        	pop	b
 0092 D1        	pop	d
 0093 E1        	pop	h
 0094 C9        	ret
                
 0095 F5        hexout:	push	psw
 0096 0F        	rrc
 0097 0F        	rrc
 0098 0F        	rrc
 0099 0F        	rrc
 009A CD9E00    	call	hexdig
 009D F1        	pop	psw
 009E E60F      hexdig:	ani	0fh
 00A0 C690      	adi	90h
 00A2 27        	daa
 00A3 CE40      	aci	40h
 00A5 27        	daa
 00A6 77        	mov	m,a
 00A7 23        	inx	h
 00A8 C9        	ret
                
                	dseg
 0000 00        b0:	db	0
 0001 00        b1:	db	0
                
 0002 4C6F63616Cldrv:	db	'Local '
 0008 5F3A0D0A24l0:	db	'_:',cr,lf,'$'
 000D 4E6574776Fnetwk:	db	'Network '
 0015 5F3A203D20n0:	db	'_: = '
 001A 5F3A5B    n1:	db	'_:['
 001D 5F5F5D0D0An2:	db	'__]',cr,lf,'$'
                
 0023 4C6F63616Cllst:	db	'Local LST:',cr,lf,'$'
 0030 4E6574776Fnlst:	db	'Network LST: = '
 003F 5F5B      nl1:	db	'_['
 0041 5F5F5D0D0Anl2:	db	'__]',cr,lf,'$'
                
 0047           	end
