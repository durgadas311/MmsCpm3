                ; Initialization code for NDOS3 on WIZ850io
                ; Checks for CP/NET already running, then initializes WIZ850io
                ;
                	maclib	z80
                
                	extrn	wizcfg
                	extrn	cpnsetup
                	public	nvbuf
                
 000D =         cr	equ	13
 000A =         lf	equ	10
                
                ; System page-0 constants
 0000 =         cpm	equ	0
 0005 =         bdos	equ	5
                
                ; BDOS functions
 0009 =         print	equ	9
 000C =         vers	equ	12
                ; NDOS functions
 0045 =         cfgtbl	equ	69
                
                ; RSX is already linked-in, but might be a duplicate
                
                	cseg
 0000 317300    	lxi	sp,stack
                
                	lixd	bdos+1	; this should be our NDOS3
 0003+DD2A      	DB	0DDH,2AH
 0005+0600      	DW	BDOS+1
                	sixd	us
 0007+DD22      	DB	0DDH,22H
 0009+0000      	DW	US
                	ldx	l,+4	; next RSX...
 000B+DD6E04    	DB	0DDH,L*8+46H,+4
                	ldx	h,+5	;
 000E+DD6605    	DB	0DDH,H*8+46H,+5
 0011 220200    	shld	next
 0014 0E0C      	mvi	c,vers
 0016 CD5F00    	call	bdose	; by-pass ourself
 0019 7C        	mov	a,h
 001A E602      	ani	02h
 001C CA3E00    	jz	ldr3
                	lixd	us
 001F+DD2A      	DB	0DDH,2AH
 0021+0000      	DW	US
                	mvix	0ffh,+8	; set remove flag
 0023+DD3608FF  	DB	0DDH,36H,+8,0FFH
                	; also short-circuit it
                	ldx	l,+4	; next RSX...
 0027+DD6E04    	DB	0DDH,L*8+46H,+4
                	ldx	h,+5	;
 002A+DD6605    	DB	0DDH,H*8+46H,+5
                	stx	l,+1	; by-pass duplicate
 002D+DD7501    	DB	0DDH,70H+L,+1
                	stx	h,+2	;
 0030+DD7402    	DB	0DDH,70H+H,+2
                	; report what happened
 0033 110400    	lxi	d,dupmsg
 0036 0E09      	mvi	c,print
 0038 CD0500    	call	bdos
 003B C30000    	jmp	cpm
                
                ; hit LOADER3 RSX, no dup found...
                ldr3:
 003E CD0000    	call	wizcfg
                	jrc	wizerr
 0041+380E      	DB	38H,WIZERR-$-1
                	; This will also cold-start NDOS...
                	; hopefully, no bad effects.
 0043 0E45      	mvi	c,cfgtbl
 0045 CD0500    	call	bdos
                	; HL=cfgtbl (check error?)
 0048 119301    	lxi	d,nvbuf+288	; 64 bytes for cfgtbl template
 004B CD0000    	call	cpnsetup
 004E C30000    	jmp	cpm
                wizerr:
 0051 CD5700    	call	nocfg	; report error, but continue...
 0054 C30000    	jmp	cpm	; let RSX init itself
                
 0057 111C00    nocfg:	lxi	d,ncfg
 005A 0E09      	mvi	c,print
 005C C30500    	jmp	bdos
                
 005F 2A0200    bdose:	lhld	next
 0062 E9        	pchl
                
                	dseg
 0000 0000      us:	dw	0	; our copy of NDOS3 (remove if dup)
 0002 0000      next:	dw	0
                
 0004 43502F4E45dupmsg:	db	'CP/NET already loaded',cr,lf,'$'
 001C 4E5652414Dncfg:	db	'NVRAM not configured',cr,lf,'$'
                
 0033           	ds	64
 0073           stack:	ds	0
                
 0073           nvbuf:	ds	512
                
 0273           	end
