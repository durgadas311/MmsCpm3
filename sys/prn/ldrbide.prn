 2032 =         VERS	EQU   '2 '  ; April 7, 2020 17:45 drm "ldrbide.asm"
                
                	MACLIB	z80
                	$-MACRO
                
                	extrn cboot,btend,loader
                
                ***** PHYSICAL DRIVES ARE ASSIGNED AS FOLLOWS *****
                *****					      *****
                *****	   50 - 58 Sasi drives		      *****
                *****					      *****
                ***************************************************
                
                ***************************************************
                **  PORTS AND CONSTANTS
                ***************************************************
                
 00F0 =         ?H8PT	EQU	0F0H
 00F2 =         ?PORT	EQU	0F2H
 00F3 =         ?PORT2	EQU	0F3H
                
 2036 =         ctl$F2	EQU	2036H		; last image of ?PORT
 2377 =         SYSADR	EQU	2377H		; ADDRESS OF WHERE THE PARTN LBA
                				; SHOULD BE FOR BOOT LOADER TO PUT PARTITION
                				; ADDRESS IN.
 2156 =         SEGOFF	EQU	2156H		; address where ROM put segment offset
                
 0080 =         GIDE	equ	080h	; GIDE base port
 0088 =         GIDE$DA	equ	GIDE+8	; GIDE data port
 0089 =         GIDE$EF	equ	GIDE+9	; GIDE feature/error register
 008A =         GIDE$SC	equ	GIDE+10	; GIDE sector count
 008B =         GIDE$SE	equ	GIDE+11	; GIDE sector number	(lba7:0)
 008C =         GIDE$CL	equ	GIDE+12	; GIDE cylinder low	(lba15:8)
 008D =         GIDE$CH	equ	GIDE+13	; GIDE cylinder high	(lba23:16)
 008E =         GIDE$DH	equ	GIDE+14	; GIDE drive+head	(drive+lba27:24)
 008F =         GIDE$CS	equ	GIDE+15	; GIDE command/status
                
 0008 =         DRQ	EQU	00001000B
 0040 =         RDY	EQU	01000000B
 0001 =         ERR	EQU	00000001B
 0080 =         BUSY	EQU	10000000B
                
                
                ***************************************************
                ** START OF RELOCATABLE DISK BOOT MODULE
                *************************************************** 
                	aseg
 2280           	org	2280H
 2280 C38B22    boot:	jmp	around
                
 2283 0000      sysend: dw	btend
 2285 0000      systrt: dw	loader
 2287 00        drive:	db	0	;boot drive - calculated at run time
 2288 00        btmode: db	0	;not used by this hard disk loader
 2289 46        	db	70	;first drive
 228A 09        	db	9	;number of drives
                
 228B E1        around: pop	h	;ADDRESS OF ERROR ROUTINE
 228C 31FF23    	lxi	sp,?stack
 228F E5        	push	h
                
                *****************************************
                * Start of unique routine for booting 
                *****************************************
                
 2290 210000    	lxi	h,btend
 2293 110000    	lxi	d,loader
 2296 B7        	ora	a
 2297           	dsbc	d		;length of system in bytes
 2299 227C23    	shld	syssiz
 229C 110001    	lxi	d,100h		;add boot module size
 229F 19        	dad	d
 22A0 0609      	mvi	b,9	; 2^9 = 512
 22A2           	srlr	h	; >>9 == >>8 (byte) and >>1
 22A4 24        	inr	h		; PHYSICAL SECTORS TO BE BOOTED (rounded up)
 22A5 5C        	mov	e,h	; sector count to E
                	; SYSADR already has SEGOFF...
 22A6 3A7723    	lda	SYSADR+0
 22A9 F6E0      	ori	11100000b
 22AB D38E      	out	GIDE$DH	; LBA 27:24, drive and mode
 22AD 3A7823    	lda	SYSADR+1
 22B0 D38D      	out	GIDE$CH	; LBA 23:16
 22B2 3A7923    	lda	SYSADR+2
 22B5 D38C      	out	GIDE$CL	; LBA 15:8
 22B7 3A7A23    	lda	SYSADR+3
 22BA D38B      	out	GIDE$SE	; LBA 7:0
 22BC 7B        	mov	a,e
 22BD D38A      	out	GIDE$SC
 22BF 3E20      	mvi	a,20h
 22C1 D38F      	out	GIDE$CS
 22C3 210030    	lxi	h,3000h
 22C6 0E88      	mvi	c,GIDE$DA
 22C8 0600      	mvi	b,0	; should always be 0 after inir
                load:
 22CA DB8F      	in	GIDE$CS
 22CC           	bit	7,a	; BUSY
 22CE           	jrnz	load
 22D0           	bit	0,a	; ERR
 22D2 C0        	rnz
 22D3           	bit	6,a	; RDY
 22D5 C8        	rz
 22D6           	bit	3,a	; DRQ
 22D8           	jrz	load
 22DA           	inir	; 256 bytes
 22DC           	inir	; 512 bytes
 22DE 1D        	dcr	e
 22DF           	jrnz	load
                
 22E1 F3        DONE:	DI
 22E2 3E9F      	mvi	a,10011111b	; H8 2mS off, display blank
 22E4 D3F0      	out	?H8PT		; H89 NMI here should be OK
 22E6 3E02      	mvi	a,00000010b	; aux 2mS enable
 22E8 D3F3      	out	?PORT2		; in case of H8 CPU
 22EA 3A3620    	lda	ctl$F2
 22ED E6FD      	ani	11111101b	; CLK off
 22EF D3F2      	out	?PORT
 22F1 E620      	ani	00100000b	; ORG0 already?
 22F3           	jrnz	done2
 22F5 210D23    	LXI	H,?CODE ;SEQUENCE TO MOVE MEMORY-MAP
 22F8 0607      	MVI	B,?CODE$LEN	;NUMBER OF BYTES IN SEQUENCE
 22FA 0EF2      	MVI	C,?PORT ;I/O PORT TO SEND SEQUENCE
 22FC           	OUTIR
 22FE 210031    done2:	lxi	h,3000h+256
 2301 110000    	lxi	d,loader
 2304           	lbcd	syssiz
 2308           	ldir
 230A C30000    	jmp	cboot
                
 230D 04        ?CODE	DB	0000$01$00B
 230E 0C        	DB	0000$11$00B
 230F 04        	DB	0000$01$00B
 2310 08        	DB	0000$10$00B
 2311 0C        	DB	0000$11$00B
 2312 08        	DB	0000$10$00B
 2313 20        	DB	0010$00$00B	;changes memory if "-FA" also
 0007 =         ?CODE$LEN	EQU	$-?CODE
                
                	; TODO: detect overrun at assembler  time
 2377           	ORG	SYSADR
 2377 00000000  LBA:	DB	0,0,0,0	; synonymous with SYSADR
 237B 00        STAT:	DB	0
 237C 0000      syssiz	dw	0
                
                	REPT	256-($-BOOT)-1
                	DB	0
                	ENDM
                
 23FF =         ?stack: equ	$+128
                
 237F           	END
