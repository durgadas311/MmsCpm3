                ; CPM3LDR program code
                
                	maclib	z80
                
                	public	loader
                	extrn	bdos
                
 000D =         CR	equ	13
 000A =         LF	equ	10
 0009 =         TAB	equ	9
 0008 =         BS	equ	8
 0007 =         BEL	equ	7
 007F =         DEL	equ	127
                
                ; locations in page-0
 0008 =         rst1	equ	0008h
 000B =         ticker	equ	000bh
 000D =         gpbyte	equ	000dh
 000E =         l000eh	equ	000eh
 0080 =         dmabuf	equ	0080h
                
 0009 =         msgout	equ	9
 000D =         reset	equ	13
 000F =         open	equ	15
 0014 =         read	equ	20
 001A =         setdma	equ	26
                
                	cseg
 0100           	org	0100h
                loader:
 0100 0E0D      	mvi c,reset	;0200 0e 0d . .
 0102 CD0000    	call bdos	;0202	cd fb 02 	. . . 
 0105 0E0F      	mvi c,open	;0205 0e 0f . .
 0107 118B01    	lxi d,cpm3sys	;0207 11 8b 02 . . .
 010A CD0000    	call bdos	;020a	cd fb 02 	. . . 
 010D FEFF      	cpi 0ffh	;020d fe ff . .
 010F 11AF01    	lxi d,fnfmsg	;020f 11 af 02 . . .
 0112 CA8401    	jz die		;0212 ca 84 02 . . .
 0115 118000    	lxi d,dmabuf	;0215 11 80 00 . . .
 0118 CD7101    	call st$dma	;0218	cd 71 02 	. q . 
 011B CD7701    	call rd$file	; load header
                
 011E 218000    	lxi h,dmabuf	;021e 21 80 00 . . .
 0121 11F501    	lxi d,header	;0221 11 f5 02 . . .
 0124 0E06      	mvi c,6		;0224 0e 06 . .
                memcpy:
 0126 7E        	mov a,m		;0226 7e ~
 0127 12        	stax d		;0227 12 .
 0128 13        	inx d		;0228 13 .
 0129 23        	inx h		;0229 23 #
 012A 0D        	dcr c		;022a 0d .
 012B C22601    	jnz memcpy	;022b c2 26 02 . & .
                
 012E CD7701    	call rd$file	; load message (optional)
 0131 0E09      	mvi c,msgout	;0231 0e 09 . .
 0133 118000    	lxi d,dmabuf	;0233 11 80 00 . . .
 0136 CD0000    	call bdos	;0236	cd fb 02 	. . . 
 0139 3AF601    	lda respgs	;0239 3a f6 02 : . .
 013C 67        	mov h,a		;023c 67 g
 013D 3AF501    	lda restop	;023d 3a f5 02 : . .
 0140 CD5501    	call loadit	;0240	cd 55 02 	. U . 
 0143 3AF801    	lda bnkpgs	;0243 3a f8 02 : . .
 0146 B7        	ora a		;0246 b7 .
 0147 CA5101    	jz nobnk	;0247 ca 51 02 . Q .
 014A 67        	mov h,a		;024a 67 g
 014B 3AF701    	lda bnktop	;024b 3a f7 02 : . .
 014E CD5501    	call loadit	;024e	cd 55 02 	. U . 
                nobnk:
 0151 2AF901    	lhld osntry	;0251 2a f9 02 * . .
 0154 E9        	pchl 		;0254 e9 .
                
                ; H = num pages to load, A = starting (top) page.
                ; Loads records *backward* into memory.
                loadit:
 0155 B7        	ora a		;0255 b7 .
 0156 57        	mov d,a		;0256 57 W
 0157 1E00      	mvi e,0		;0257 1e 00 . .
 0159 7C        	mov a,h		;0259 7c |
 015A 17        	ral		;025a 17 .
 015B 67        	mov h,a		;025b 67 g
                nxtrec:
 015C EB        	xchg 		;025c eb .
 015D 0180FF    	lxi b,-128	;025d 01 80 ff . . .
 0160 09        	dad b		;0260 09 .
 0161 EB        	xchg 		;0261 eb .
 0162 D5        	push d		;0262 d5 .
 0163 E5        	push h		;0263 e5 .
 0164 CD7101    	call st$dma	;0264	cd 71 02 	. q . 
 0167 CD7701    	call rd$file	;0267	cd 77 02 	. w . 
 016A E1        	pop h		;026a e1 .
 016B D1        	pop d		;026b d1 .
 016C 25        	dcr h		;026c 25 %
 016D C25C01    	jnz nxtrec	;026d c2 5c 02 . \ .
 0170 C9        	ret		;0270	c9 	. 
                
                st$dma:
 0171 0E1A      	mvi c,setdma	;0271 0e 1a . .
 0173 CD0000    	call bdos	;0273	cd fb 02 	. . . 
 0176 C9        	ret		;0276	c9 	. 
                
                rd$file:
 0177 0E14      	mvi c,read	;0277 0e 14 . .
 0179 118B01    	lxi d,cpm3sys	;0279 11 8b 02 . . .
 017C CD0000    	call bdos	;027c	cd fb 02 	. . . 
 017F B7        	ora a		;027f b7 .
 0180 11D301    	lxi d,rdemsg	;0280 11 d3 02 . . .
 0183 C8        	rz 		;0283 c8 .
                	; fall-through to die()
                die:
 0184 0E09      	mvi c,msgout	;0284 0e 09 . .
 0186 CD0000    	call bdos	;0286	cd fb 02 	. . . 
 0189 F3        	di		;0289	f3 	. 
 018A 76        	hlt		;028a 76 v
                
                cpm3sys:
 018B 0043504D33	db	0,'CPM3    SYS',0,0,0,0
 019B 0000000000	db	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
 01AB 00000000  	db	0,0,0,0
                
                fnfmsg:
 01AF 0D0A657272	db	CR,LF,'error: File not found: CPM3.SYS'
 01D0 0D0A24    	db	CR,LF,'$'
                
                rdemsg:
 01D3 0D0A657272	db	CR,LF,'error: Read failure: CPM3.SYS'
 01F2 0D0A24    	db	CR,LF,'$'
                
                ; load/run params
                header:
 01F5 00        restop:	db	0	; top page for RES	00
 01F6 00        respgs:	db	0	; num pages		0f
 01F7 00        bnktop:	db	0	; top page for BNK	e0
 01F8 00        bnkpgs:	db	0	; num pages		4e
 01F9 0000      osntry:	dw	0	; entry point (cboot)	f700
                
 01FB           	end
