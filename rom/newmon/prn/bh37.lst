		; Boot Module for H37
		; TODO: make port variable...
		
			maclib	ram
**** ram.lib ****
**** bh37.asm ****
			maclib	core
**** core.lib ****
**** bh37.asm ****
			maclib	z80
**** z80.lib ****
**** bh37.asm ****
		
1000          		org	1000h
1000  01      	first:	db	HIGH (last-first)	; +0: num pages
1001  10      		db	HIGH first		; +1: ORG page
1002  2E04    		db	46,4	; +2,+3: phy drv base, num
		
1004  C31410  		jmp	init	; +4: init entry
1007  C31610  		jmp	boot	; +7: boot entry
		
100A  43      		db	'C'	; +10: Boot command letter
100B  03      		db	3	; +11: front panel key
100C  78      		db	78h	; +12: port, 0 if variable
100D  92E0F1  		db	10010010b,11100000b,11110001b	; +13: FP display ("H37")
1010  48333700		db	'H37',0	; +16: mnemonic string
		
1014  AF      	init:	xra	a	; NC
1015  C9      		ret
		
1016          	boot:
1016  219F10  		lxi	h,intz37
1019  222920  		shld	vrst4+1
101C  2B      		dcx	h
101D  223720  		shld	l2037h
1020  3A3121  		lda	AIO$UNI
1023  FE04    		cpi	004h
1025  D0      		rnc
1026  3C      		inr	a
1027  2E08    		mvi	l,00001000b
1029          	bz37$0:
1029  29      		dad	h
102A  3D      		dcr	a
102B  20FC    		jrnz	bz37$0
102D  D379    		out	079h
102F  DBF2    		in	0f2h
1031  E60C    		ani	00ch
1033  C0      		rnz
1034  3E78    		mvi	a,078h
1036  325021  		sta	cport
1039  3ED0    		mvi	a,0d0h
103B  D37A    		out	07ah
103D  7D      		mov	a,l
103E  F608    		ori	00001000b
1040  57      		mov	d,a
1041  D378    		out	078h
1043  14      		inr	d
1044  1E19    		mvi	e,019h
1046  3E05    		mvi	a,5
1048  CD4100  		call	take$A
104B  017B14  		lxi	b,0147bh	; mask, port
104E          	bz37$1:
104E  DB7A    		in	07ah
1050  A8      		xra	b
1051  E602    		ani	002h
1053  28F9    		jrz	bz37$1
1055  10F7    		djnz	bz37$1
1057          	bz37$2:
1057  218022  		lxi	h,bootbf
105A  3E01    		mvi	a,001h
105C  D379    		out	079h
105E  D37A    		out	07ah
1060  7A      		mov	a,d
1061  D378    		out	078h
1063  0604    		mvi	b,004h
1065          	bz37$3:
1065  AF      		xra	a
1066  D379    		out	079h
1068  3E40    		mvi	a,040h
106A  D37A    		out	07ah
106C  CDA810  		call	ei$spin
106F  10F4    		djnz	bz37$3
1071  AF      		xra	a
1072  D379    		out	079h
1074  3E0B    		mvi	a,00bh
1076  D37A    		out	07ah
1078  CDA810  		call	ei$spin
107B  7A      		mov	a,d
107C  EE04    		xri	004h
107E  57      		mov	d,a
107F  F602    		ori	002h
1081  D378    		out	078h
1083  3E9C    		mvi	a,09ch
1085  D37A    		out	07ah
1087  CDAB10  		call	hlt$ini
108A  E6EF    		ani	0efh
108C  200D    		jrnz	bz37$4
108E  7C      		mov	a,h
108F  FE2C    		cpi	02ch
1091  3808    		jrc	bz37$4
1093  3E08    		mvi	a,008h
1095  D378    		out	078h
1097  E1      		pop	h
1098  C33B00  		jmp	hwboot
109B          	bz37$4:
109B  1D      		dcr	e
109C  20B9    		jrnz	bz37$2
109E  C9      		ret
		
109F  DB7A    	intz37:	in	07ah
10A1  E3      		xthl
10A2  2A3720  		lhld	l2037h
10A5  E3      		xthl
10A6  FB      		ei
10A7  C9      		ret
		
10A8  FB      	ei$spin: ei
10A9  18FE    		jr	$-1	; wait for intr to break us out
		
10AB  FB      	hlt$ini: ei
10AC  76      	rd316$0: hlt
10AD  EDA2    		ini
10AF  C3AC10  		jmp	rd316$0
		
10B2  FFFFFFFF		rept	(($+0ffh) and 0ff00h)-$
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFF
0000          	if ($ > 1800h)
		endif
		
1100          	last:	end



Statistics:

     4	passes
     0	jr promotions
    78	symbols
   256	bytes

   103	macro calls
  3759	macro bytes
     0	invented symbols
