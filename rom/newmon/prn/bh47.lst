		; Boot Module for H47
			maclib	ram
**** ram.lib ****
**** bh47.asm ****
			maclib	core
**** core.lib ****
**** bh47.asm ****
			maclib	z80
**** z80.lib ****
**** bh47.asm ****
		
1000          		org	1000h
1000  01      	first:	db	HIGH (last-first)	; +0: num pages
1001  10      		db	HIGH first		; +1: ORG page
1002  0504    		db	5,4	; +2,+3: phy drv base, num
		
1004  C31410  		jmp	init	; +4: init entry
1007  C33310  		jmp	boot	; +7: boot entry
		
100A  44      		db	'D'	; +10: Boot command letter
100B  01      		db	1	; +11: front panel key
100C  00      		db	0	; +12: port, 0 if variable
100D  92B2F1  		db	10010010b,10110010b,11110001b	; +13: FP display ("H47")
1010  48343700		db	'H47',0	; +16: mnemonic string
		
1014          	init:
1014  0E01    		mvi	c,01b
1016  CD0400  		call	getport	; no return on error
1019  2004    		jrnz	init0	; not fatal, if caller gets port later
101B  78      		mov	a,b
101C  325021  		sta	cport
101F          	init0:
			; 'JMP' already in place
101F  219E10  		lxi	h,z47$dati
1022  223801  		shld	h47$dati+1
1025  217310  		lxi	h,z47$dato
1028  221406  		shld	h47$dato+1
102B  217710  		lxi	h,z47$cmdo
102E  221806  		shld	h47$cmdo+1
1031  AF      		xra	a	; NC
1032  C9      		ret
		
1033          	boot:
1033  3A3121  		lda	AIO$UNI
1036  0F      		rrc		; u000000u
1037  0F      		rrc		; uu000000
1038  0F      		rrc		; 0uu00000
1039  3C      		inr	a	; 0uu00001
103A  5F      		mov	e,a
103B  3E05    		mvi	a,5
103D  CD4100  		call	take$A	; error out after 5 seconds...
1040  3E02    		mvi	a,2
1042  CD8410  		call	outport0
1045  3E02    		mvi	a,2
1047  CD7710  		call	z47$cmdo
104A  7B      		mov	a,e
104B  CD7310  		call	z47$dato
104E  CD9E10  		call	z47$dati
1051  E60C    		ani	00ch
1053  0F      		rrc
1054  0F      		rrc
1055  3C      		inr	a
1056  47      		mov	b,a
1057  3E01    		mvi	a,1
1059          	bz47$0:
1059  87      		add	a
105A  10FD    		djnz	bz47$0
105C  1F      		rar
105D  47      		mov	b,a
105E  218022  		lxi	h,bootbf
1061  C5      		push	b
1062  CDA710  		call	z47$read
1065  C1      		pop	b
1066  1C      		inr	e
1067  CDA710  		call	z47$read
106A  CD9210  		call	inport0
106D  E601    		ani	001h
106F  C0      		rnz
1070  C33B00  		jmp	hwboot
		
1073          	z47$dato:
1073  1680    		mvi	d,080h	; TR - date transfer request
1075  1802    		jr	z47$out0
1077          	z47$cmdo:
1077  1620    		mvi	d,020h	; DONE
1079          	z47$out0:
1079  37      		stc
107A  F5      		push	psw
107B          	z47$wt0:
107B  CD9210  		call	inport0
107E  A2      		ana	d
107F  28FA    		jrz	z47$wt0
1081  F1      		pop	psw
1082  1801    		jr	z47$out1
1084          	outport0:
1084  B7      		ora	a
1085          	z47$out1:
1085  C5      		push	b
1086  47      		mov	b,a
1087  3A5021  		lda	cport
108A  CE00    		aci	0
108C  4F      		mov	c,a
108D  78      		mov	a,b
108E  ED79    		outp	a
1090  C1      		pop	b
1091  C9      		ret
		
1092          	inport0:
1092  B7      		ora	a	; NC
1093          	inportx:	; input from cport+CY
1093  C5      		push	b
1094  3A5021  		lda	cport
1097  CE00    		aci	0
1099  4F      		mov	c,a
109A  ED78    		inp	a
109C  C1      		pop	b
109D  C9      		ret
		
109E          	z47$dati:
109E  CD9210  		call	inport0
10A1  07      		rlc	; TR
10A2  30FA    		jrnc	z47$dati
10A4  C39310  		jmp	inportx	; CY=1, input cport+1
		
10A7          	z47$read:
10A7  3E07    		mvi	a,7	; read thru buffer command
10A9  CD7710  		call	z47$cmdo
10AC  AF      		xra	a
10AD  CD7310  		call	z47$dato	; params
10B0  7B      		mov	a,e
10B1  CD7310  		call	z47$dato	; params
10B4          	z47$rd0:
10B4  0E80    		mvi	c,128
10B6          	z47$rd1:
10B6  CD9E10  		call	z47$dati
10B9  77      		mov	m,a
10BA  23      		inx	h
10BB  0D      		dcr	c
10BC  20F8    		jrnz	z47$rd1
10BE  05      		dcr	b
10BF  20F3    		jrnz	z47$rd0
10C1  C9      		ret
		
10C2  FFFFFFFF		rept	(($+0ffh) and 0ff00h)-$
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFF
0000          	if ($ > 1800h)
		endif
		
1100          	last:	end



Statistics:

     4	passes
     0	jr promotions
    84	symbols
   256	bytes

    88	macro calls
  3759	macro bytes
     0	invented symbols
