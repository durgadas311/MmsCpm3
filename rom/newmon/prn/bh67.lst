		; Boot Module for H67
			maclib	ram
**** ram.lib ****
**** bh67.asm ****
			maclib	core
**** core.lib ****
**** bh67.asm ****
			maclib	setup
**** setup.lib ****
**** bh67.asm ****
			maclib	z80
**** z80.lib ****
**** bh67.asm ****
		
1000          		org	1000h
1000  02      	first:	db	HIGH (last-first)	; +0: num pages
1001  10      		db	HIGH first		; +1: ORG page
1002  0302    		db	3,2	; +2,+3: phy drv base, num
		
1004  C31410  		jmp	init	; +4: init entry
1007  C32810  		jmp	boot	; +7: boot entry
		
100A  45      		db	'E'	; +10: Boot command letter
100B  02      		db	2	; +11: front panel key
100C  00      		db	0	; +12: port, 0 if variable
100D  9284F1  		db	10010010b,10000100b,11110001b	; +13: FP display ("H67")
1010  48363700		db	'H67',0	; +16: mnemonic string
		
1014          	init:
1014  3A0BF9  		lda	susave+h67pt
1017  FEFF    		cpi	0ffh
1019  2008    		jrnz	init1
101B  0E02    		mvi	c,10b
101D  CD0400  		call	getport	; no return on error
1020  2004    		jrnz	init0	; not fatal, if caller gets port later
1022  78      		mov	a,b
1023  325021  	init1:	sta	cport
1026  AF      	init0:	xra	a	; NC
1027  C9      		ret
		
1028          	boot:
1028  3A5021  		lda	cport
102B  3C      		inr	a
102C  4F      		mov	c,a
102D  AF      		xra	a
102E  ED79    		outp	a
1030  210000  		lxi	h,0		; zero-out command buffer
1033  223221  		shld	cmdbuf
1036  223421  		shld	cmdbuf+2
1039  223621  		shld	cmdbuf+4
103C  225621  		shld	l2156h	; zero-out ...
103F  225821  		shld	l2156h+2
1042  325A21  		sta	l2156h+4
1045  3A3121  		lda	AIO$UNI	; set LUN in cmdbuf
1048  0F      		rrc		;
1049  0F      		rrc		;
104A  0F      		rrc		;
104B  323321  		sta	cmdbuf+1;
104E  1600    		mvi	d,0	; controller number
1050  3E04    		mvi	a,4	; delay 8mS, also NZ
1052  B7      		ora	a
1053  FB      		ei
1054          	bsasi0:
1054  C8      		rz
1055  CD2B00  		call	delay
1058  1E00    		mvi	e,0	; Test Drive Ready
105A  CD7610  		call	sasi$cmd
105D  3EFF    		mvi	a,255	; longer delay on retry...
105F  38F3    		jrc	bsasi0
1061  1E01    		mvi	e,1	; Recalibrate (Home)
1063  CD7610  		call	sasi$cmd
1066  D8      		rc
1067  210A80  		lxi	h,0800ah	; 10 sectors, retry 8
106A  223621  		shld	cmdbuf+4
106D  1E08    		mvi	e,8	; Read
106F  CD7610  		call	sasi$cmd
1072  D8      		rc
1073  C33B00  		jmp	hwboot
		
		; send SASI read command, get results
1076          	sasi$cmd:
1076  F3      		di
1077  7B      		mov	a,e
1078  323221  		sta	cmdbuf
107B  0600    		mvi	b,0	; wait for "not BUSY" first
107D  1E06    		mvi	e,6	;
107F  210000  		lxi	h,0	; 0x060000 loop/timeout count
1082          	sscmd0:
1082  ED78    		inp	a
1084  E608    		ani	00001000b
1086  B8      		cmp	b
1087  280A    		jrz	sscmd1
1089  2B      		dcx	h
108A  7D      		mov	a,l
108B  B4      		ora	h
108C  20F4    		jrnz	sscmd0
108E  1D      		dcr	e
108F  20F1    		jrnz	sscmd0
1091  37      		stc
1092  C9      		ret
1093          	sscmd1:
1093  78      		mov	a,b
1094  EE08    		xri	00001000b	; wait for BUSY
1096  2810    		jrz	sscmd2		; got BUSY...
1098  47      		mov	b,a
1099  0D      		dcr	c
109A  AF      		xra	a
109B  ED79    		outp	a
109D  0C      		inr	c
109E  0C      		inr	c
109F  ED51    		outp	d	; controller number
10A1  0D      		dcr	c
10A2  3E40    		mvi	a,040h	; SELECT
10A4  ED79    		outp	a
10A6  18DA    		jr	sscmd0	; wait for BUSY now...
		
10A8          	sscmd2:
10A8  3E02    		mvi	a,002h	; enable INTR
10AA  ED79    		outp	a
10AC  213221  		lxi	h,cmdbuf
10AF          	sscmd3:
10AF  ED78    		inp	a
10B1  CB7F    		bit	7,a	; REQ
10B3  28FA    		jrz	sscmd3
10B5  CB67    		bit	4,a	; CMD
10B7  280A    		jrz	sscmd4
10B9  CB77    		bit	6,a	; MSG
10BB  2819    		jrz	sscmd6
10BD  0D      		dcr	c
10BE  EDA3    		outi		; output command byte
10C0  0C      		inr	c
10C1  18EC    		jr	sscmd3
		
10C3          	sscmd4:
10C3  218022  		lxi	h,bootbf
10C6          	sscmd5:
10C6  ED78    		inp	a
10C8  CB7F    		bit	7,a	; REQ
10CA  28FA    		jrz	sscmd5
10CC  CB67    		bit	4,a	; CMD - indicates data done
10CE  2006    		jrnz	sscmd6
10D0  0D      		dcr	c
10D1  EDA2    		ini		; input data byte
10D3  0C      		inr	c
10D4  18F0    		jr	sscmd5
10D6          	sscmd6:
10D6  ED78    		inp	a
10D8  E6D0    		ani	0d0h	; REQ, OUT, CMD
10DA  FE90    		cpi	090h	; must be REQ, CMD
10DC  20F8    		jrnz	sscmd6	; wait for it...
10DE  0D      		dcr	c
10DF  ED68    		inp	l	; result 0
10E1  0C      		inr	c
10E2          	sscmd7:
10E2  ED60    		inp	h	; status
10E4  7C      		mov	a,h
10E5  E6E0    		ani	0e0h	; REG, OUT, MSG
10E7  FEA0    		cpi	0a0h	; must be REQ, MSG
10E9  20F7    		jrnz	sscmd7
10EB  223821  		shld	resbuf	; command results
10EE  0D      		dcr	c
10EF  ED78    		inp	a	; last data byte
10F1  0C      		inr	c
10F2  FB      		ei
10F3  B7      		ora	a
10F4  37      		stc
10F5  C0      		rnz		; error
10F6  CB45    		bit	0,l	; SASI error bit
10F8  C0      		rnz
10F9  CB4D    		bit	1,l	; or other error?
10FB  C0      		rnz
10FC  CB4C    		bit	1,h	; ACK
10FE  C0      		rnz
10FF  AF      		xra	a	; success
1100  C9      		ret
		
1101  FFFFFFFF		rept	(($+0ffh) and 0ff00h)-$
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFF
0000          	if ($ > 1800h)
		endif
		
1200          	last:	end



Statistics:

     4	passes
     0	jr promotions
   116	symbols
   512	bytes

   328	macro calls
  3759	macro bytes
     0	invented symbols
