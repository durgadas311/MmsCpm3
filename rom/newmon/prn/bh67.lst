		; Boot Module for H67
			maclib	ram
**** ram.lib ****
**** bh67.asm ****
			maclib	core
**** core.lib ****
**** bh67.asm ****
			maclib	z80
**** z80.lib ****
**** bh67.asm ****
		
1000          		org	1000h
1000  01      	first:	db	HIGH (last-first)	; +0: num pages
1001  10      		db	HIGH first		; +1: ORG page
1002  0302    		db	3,2	; +2,+3: phy drv base, num
		
1004  C31410  		jmp	init	; +4: init entry
1007  C32110  		jmp	boot	; +7: boot entry
		
100A  45      		db	'E'	; +10: Boot command letter
100B  02      		db	2	; +11: front panel key
100C  00      		db	0	; +12: port, 0 if variable
100D  9284F1  		db	10010010b,10000100b,11110001b	; +13: FP display ("H67")
1010  48363700		db	'H67',0	; +16: mnemonic string
		
1014          	init:
1014  0E02    		mvi	c,10b
1016  CD0400  		call	getport	; no return on error
1019  2004    		jrnz	init0	; not fatal, if caller gets port later
101B  78      		mov	a,b
101C  325021  		sta	cport
101F  AF      	init0:	xra	a	; NC
1020  C9      		ret
		
1021          	boot:
1021  3A3121  		lda	AIO$UNI
1024  0F      		rrc
1025  0F      		rrc
1026  0F      		rrc
1027  DD      		db 0ddh
1028  67      		mov h,a	; movxh	a	; 0xx00000 = relative drive num (LUN)
1029  3A5021  		lda	cport
102C  3C      		inr	a
102D  4F      		mov	c,a
102E  AF      		xra	a
102F  ED79    		outp	a
1031  210000  		lxi	h,0		; zero-out command buffer
1034  223221  		shld	cmdbuf
1037  223421  		shld	cmdbuf+2
103A  223621  		shld	cmdbuf+4
103D  225621  		shld	l2156h	; zero-out ...
1040  225821  		shld	l2156h+2
1043  325A21  		sta	l2156h+4
1046  1600    		mvi	d,0	; controller number
1048  3E04    		mvi	a,4	; delay 8mS, also NZ
104A  B7      		ora	a
104B  FB      		ei
104C          	bsasi0:
104C  C8      		rz
104D  CD2B00  		call	delay
1050  1E00    		mvi	e,0	; Test Drive Ready
1052  CD6F10  		call	sasi$cmd
1055  3EFF    		mvi	a,255	; longer delay on retry...
1057  38F3    		jrc	bsasi0
1059  1E01    		mvi	e,1	; Recalibrate (Home)
105B  CD6F10  		call	sasi$cmd
105E  D8      		rc
105F  210A80  		lxi	h,0800ah	; 10 sectors, retry 8
1062  223621  		shld	cmdbuf+4
1065  1E08    		mvi	e,8	; Read
1067  CD6F10  		call	sasi$cmd
106A  D8      		rc
106B  E1      		pop	h
106C  C33B00  		jmp	hwboot
		
		; send SASI read command, get results
106F          	sasi$cmd:
106F  F3      		di
1070  DD      		db 0ddh	; undocumented Z80 instruction
1071  6B      		mov l,e	; movxl	e	; SASI command
1072  DD223221		sixd	cmdbuf
1076  0600    		mvi	b,0	; wait for "not BUSY" first
1078  1E06    		mvi	e,6	;
107A  210000  		lxi	h,0	; 0x060000 loop/timeout count
107D          	sscmd0:
107D  ED78    		inp	a
107F  E608    		ani	00001000b
1081  B8      		cmp	b
1082  280A    		jrz	sscmd1
1084  2B      		dcx	h
1085  7D      		mov	a,l
1086  B4      		ora	h
1087  20F4    		jrnz	sscmd0
1089  1D      		dcr	e
108A  20F1    		jrnz	sscmd0
108C  37      		stc
108D  C9      		ret
108E          	sscmd1:
108E  78      		mov	a,b
108F  EE08    		xri	00001000b	; wait for BUSY
1091  2810    		jrz	sscmd2		; got BUSY...
1093  47      		mov	b,a
1094  0D      		dcr	c
1095  AF      		xra	a
1096  ED79    		outp	a
1098  0C      		inr	c
1099  0C      		inr	c
109A  ED51    		outp	d	; controller number
109C  0D      		dcr	c
109D  3E40    		mvi	a,040h	; SELECT
109F  ED79    		outp	a
10A1  18DA    		jr	sscmd0	; wait for BUSY now...
		
10A3          	sscmd2:
10A3  3E02    		mvi	a,002h	; enable INTR
10A5  ED79    		outp	a
10A7  213221  		lxi	h,cmdbuf
10AA          	sscmd3:
10AA  ED78    		inp	a
10AC  CB7F    		bit	7,a	; REQ
10AE  28FA    		jrz	sscmd3
10B0  CB67    		bit	4,a	; CMD
10B2  280A    		jrz	sscmd4
10B4  CB77    		bit	6,a	; MSG
10B6  2819    		jrz	sscmd6
10B8  0D      		dcr	c
10B9  EDA3    		outi		; output command byte
10BB  0C      		inr	c
10BC  18EC    		jr	sscmd3
		
10BE          	sscmd4:
10BE  218022  		lxi	h,bootbf
10C1          	sscmd5:
10C1  ED78    		inp	a
10C3  CB7F    		bit	7,a	; REQ
10C5  28FA    		jrz	sscmd5
10C7  CB67    		bit	4,a	; CMD - indicates data done
10C9  2006    		jrnz	sscmd6
10CB  0D      		dcr	c
10CC  EDA2    		ini		; input data byte
10CE  0C      		inr	c
10CF  18F0    		jr	sscmd5
10D1          	sscmd6:
10D1  ED78    		inp	a
10D3  E6D0    		ani	0d0h	; REQ, OUT, CMD
10D5  FE90    		cpi	090h	; must be REQ, CMD
10D7  20F8    		jrnz	sscmd6	; wait for it...
10D9  0D      		dcr	c
10DA  ED68    		inp	l	; result 0
10DC  0C      		inr	c
10DD          	sscmd7:
10DD  ED60    		inp	h	; status
10DF  7C      		mov	a,h
10E0  E6E0    		ani	0e0h	; REG, OUT, MSG
10E2  FEA0    		cpi	0a0h	; must be REQ, MSG
10E4  20F7    		jrnz	sscmd7
10E6  223821  		shld	resbuf	; command results
10E9  0D      		dcr	c
10EA  ED78    		inp	a	; last data byte
10EC  0C      		inr	c
10ED  FB      		ei
10EE  B7      		ora	a
10EF  37      		stc
10F0  C0      		rnz		; error
10F1  CB45    		bit	0,l	; SASI error bit
10F3  C0      		rnz
10F4  CB4D    		bit	1,l	; or other error?
10F6  C0      		rnz
10F7  CB4C    		bit	1,h	; ACK
10F9  C0      		rnz
10FA  AF      		xra	a	; success
10FB  C9      		ret
		
10FC  FFFFFFFF		rept	(($+0ffh) and 0ff00h)-$
0000          	if ($ > 1800h)
		endif
		
1100          	last:	end



Statistics:

     4	passes
     0	jr promotions
    80	symbols
   256	bytes

    75	macro calls
  3759	macro bytes
     0	invented symbols
