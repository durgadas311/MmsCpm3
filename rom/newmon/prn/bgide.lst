		; Boot Module for GIDE
			maclib	ram
**** ram.lib ****
**** bgide.asm ****
			maclib	core
**** core.lib ****
**** bgide.asm ****
			maclib	z80
**** z80.lib ****
**** bgide.asm ****
		
0080          	GIDE$BA	equ	80h		; GIDE base port
0088          	GIDE$DA	equ	GIDE$BA+8	; GIDE data port
0089          	GIDE$ER	equ	GIDE$BA+9	; GIDE error register (read)
0089          	GIDE$FR	equ	GIDE$BA+9	; GIDE feature register (write)
008A          	GIDE$SC	equ	GIDE$BA+10	; GIDE sector count
008B          	GIDE$SE	equ	GIDE$BA+11	; GIDE sector number
008C          	GIDE$CL	equ	GIDE$BA+12	; GIDE cylinder low
008D          	GIDE$CH	equ	GIDE$BA+13	; GIDE cylinder high
008E          	GIDE$DH	equ	GIDE$BA+14	; GIDE drive/head
008F          	GIDE$CS	equ	GIDE$BA+15	; GIDE command/status
		
0046          	drv0	equ	70
0002          	ndrv	equ	2
		
1000          		org	1000h
1000  01      	first:	db	HIGH (last-first)	; +0: num pages
1001  10      		db	HIGH first		; +1: ORG page
1002  4602    		db	drv0,ndrv	; +2,+3: phy drv base, num
		
1004  C31510  		jmp	init	; +4: init entry
1007  C31710  		jmp	boot	; +7: boot entry
		
100A  58      		db	'X'	; +10: Boot command letter
100B  04      		db	4	; +11: front panel key
100C  80      		db	80h	; +12: port, 0 if variable
100D  F3C28C  		db	11110011b,11000010b,10001100b	; +13: FP display ("IdE")
1010  47494445		db	'GIDE',0	; +16: mnemonic string
      00
		
1015  AF      	init:	xra	a	; NC
1016  C9      		ret
		
1017          	boot:
			; Partition is passed to bootloader, but we need
			; segment offset before we can start.
			; stack: retL, retH, str0, str1, ...
1017  210200  		lxi	h,2
101A  39      		dad	sp
101B  EB      		xchg		; DE=string
101C  210000  		lxi	h,0	; def seg/lun
101F  225821  		shld	l2156h+2
1022  225A21  		shld	l2156h+4
1025  3A3121  		lda	AIO$UNI	; 0000000d
1028  07      		rlc
1029  07      		rlc
102A  07      		rlc
102B  07      		rlc		; 000d0000
102C  6F      		mov	l,a	; no overlap with segment
102D  3E46    		mvi	a,drv0
102F  323420  		sta	l2034h	; pre-loader expects 70-78 for partn
1032  AF      		xra	a
1033  323121  		sta	AIO$UNI
1036  1A      		ldax	d
1037  13      		inx	d
1038  FEC3    		cpi	0c3h	; JMP means no string present
103A  2820    		jrz	nostr
103C  CD9B10  		call	trydig
103F  300F    		jrnc	gotdig
1041  CDAD10  		call	tryltr
1044  D8      		rc
1045  1A      		ldax	d
1046  13      		inx	d
1047  B7      		ora	a
1048  2812    		jrz	gotit
104A  CD9B10  		call	trydig
104D  D8      		rc
104E  1809    		jr	chkend
1050  1A      	gotdig:	ldax	d
1051  13      		inx	d
1052  B7      		ora	a
1053  2807    		jrz	gotit
1055  CDAD10  		call	tryltr
1058  D8      		rc
1059  1A      	chkend:	ldax	d
105A  B7      		ora	a
105B  C0      		rnz	; max two chars
105C          	gotit:
105C  225621  	nostr:	shld	l2156h	; l2156h[0]=DRV|27:24, l2156h[1]=23:16
105F  AF      		xra	a
1060  D389    		out	GIDE$FR	; needed after power-on?
1062  7D      		mov	a,l
1063  F6E0    		ori	11100000b	; LBA mode + std "1" bits
1065  D38E    		out	GIDE$DH	; LBA 27:4, drive 0, LBA mode
1067  7C      		mov	a,h
1068  D38D    		out	GIDE$CH	; LBA 23:16
106A  AF      		xra	a
106B  D38C    		out	GIDE$CL	; LBA 15:8
106D  D38B    		out	GIDE$SE	; LBA 7:0
106F  3E0A    		mvi	a,10
1071  D38A    		out	GIDE$SC	; 10 sectors (standard boot length)
1073  3E20    		mvi	a,20h	; READ SECTORS
1075  D38F    		out	GIDE$CS
1077  218022  		lxi	h,bootbf
107A  0E88    		mvi	c,GIDE$DA
107C  1E0A    		mvi	e,10
107E  0600    		mvi	b,0	; should always be 0 after inir
1080          	bgide0:
1080  DB8F    		in	GIDE$CS
1082  CB7F    		bit	7,a	; busy
1084  20FA    		jrnz	bgide0
1086  CB47    		bit	0,a	; error
1088  C0      		rnz
1089  CB77    		bit	6,a	; ready
108B  C8      		rz
108C  CB5F    		bit	3,a	; DRQ
108E  28F0    		jrz	bgide0
1090  EDB2    		inir	; 256 bytes
1092  EDB2    		inir	; 512 bytes
1094  1D      		dcr	e
1095  20E9    		jrnz	bgide0
			; final status check?
1097  E1      		pop	h	; adj stack for possible string
1098  C33B00  		jmp	hwboot
		
109B          	trydig:
109B  FE30    		cpi	'0'	; digit?
109D  D8      		rc	; error
109E  FE3A    		cpi	'9'+1	; max 9 partitions
10A0  3F      		cmc
10A1  D8      		rc	; error - or letter
10A2  D630    		sui	'0'
10A4  323121  		sta	AIO$UNI
10A7  C646    		adi	drv0
10A9  323420  		sta	l2034h	; pre-loader expects 70-78 for partn
10AC  C9      		ret
		
10AD          	tryltr:
10AD  FE41    		cpi	'A'
10AF  D8      		rc	; error - or digit
10B0  E65F    		ani	5fh	; toupper
10B2  D641    		sui	'A'	; 000sssss
10B4  FE1A    		cpi	26
10B6  3F      		cmc
10B7  D8      		rc
10B8  07      		rlc
10B9  07      		rlc
10BA  07      		rlc		; sssss000
10BB  67      		mov	h,a	; no overlap with DRV
10BC  C9      		ret
		
10BD  FFFFFFFF		rept	(($+0ffh) and 0ff00h)-$
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFFFF
      FFFFFF
0000          	if ($ > 1800h)
		endif
		
1100          	last:	end



Statistics:

     4	passes
     0	jr promotions
    88	symbols
   256	bytes

    97	macro calls
  3759	macro bytes
     0	invented symbols
