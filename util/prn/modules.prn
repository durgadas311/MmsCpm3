 2031 =         VERS EQU '1 ' ; JANUARY 26, 1984  17:01  DRM  "MODULES.ASM"
                
                	MACLIB Z80
                
                ; PROGRAM TO DISPLAY MODULES CURRENTLY INSTALLED FOR CP/M 3 AND MP/M-II
                
 0000 =         CPM	EQU	0
                
 0002 =         CONOUT	EQU	2
 0009 =         MSGOUT	EQU	9
 000C =         RETVER	EQU	12
                
 000D =         CR	EQU	13
 000A =         LF	EQU	10
                
 0100           	ORG	100H
 0100 C36401    BASE:	JMP	START
                
 0005 =         BDOS	EQU	BASE-100H+5
                
 0103 0D0A4D4F44SIGNON: DB	CR,LF,'MODULES v3.10'
 0112 3120      	DW	VERS
 0114 2020286329	DB	'  (c) Magnolia Microsystems',CR,LF,LF,'$'
 0133 0D0A4D7573VERR:	DB	CR,LF,'Must have MMS CP/M 3 or MP/M$'
                
 0152 113301    VERERR: LXI	D,VERR
 0155 0E09      	MVI	C,MSGOUT
 0157 CD0500    	CALL	BDOS
 015A C3F701    	JMP	XIT
                
 015D 0000      THREAD: DW	0
 015F 0000      MEMSTR: DW	0
 0161 0000      RTCSTR: DW	0
 0163 00        BIOSPG:	DB	0
                
                START:	SSPD	SAVSTK
 0164+ED73      	DB	0EDH,73H
 0166+1C02      	DW	SAVSTK
 0168 311C02    	LXI	SP,STACK
 016B 110301    	LXI	D,SIGNON
 016E 0E09      	MVI	C,MSGOUT
 0170 CD0500    	CALL	BDOS
 0173 0E0C      	MVI	C,RETVER
 0175 CD0500    	CALL	BDOS
 0178 7D        	MOV	A,L
 0179 D630      	SUI	30H
 017B FE10      	CPI	16
 017D D25201    	JNC	VERERR
 0180 7C        	MOV	A,H
 0181 2A0100    	LHLD	CPM+1
 0184 FE01      	CPI	1	;MP/M ?
 0186 7C        	MOV	A,H	; BIOS PAGE
                	JRNZ	ST0
 0187+200A      	DB	20H,ST0-$-1
 0189 23        	INX	H
 018A 5E        	MOV	E,M
 018B 23        	INX	H
 018C 56        	MOV	D,M
                	; FOR MP/M, THE STRINGS WON'T BE ABOVE BIOS JMP...
 018D 6B        	MOV	L,E
 018E 62        	MOV	H,D
 018F 23        	INX	H
 0190 23        	INX	H
 0191 7E        	MOV	A,M	; XIOS COMMON PAGE
 0192 EB        	XCHG		; HL=BIOS JMP PAGE
 0193 326301    ST0:	STA	BIOSPG
 0196 2E67      	MVI	L,67H	;THREAD
 0198 4E        	MOV	C,M
 0199 23        	INX	H
 019A 46        	MOV	B,M
                	SBCD	THREAD
 019B+ED43      	DB	0EDH,43H
 019D+5D01      	DW	THREAD
 019F 2E84      	MVI	L,84H	;MEMSTR
 01A1 4E        	MOV	C,M
 01A2 23        	INX	H
 01A3 46        	MOV	B,M
 01A4 23        	INX	H
                	SBCD	MEMSTR
 01A5+ED43      	DB	0EDH,43H
 01A7+5F01      	DW	MEMSTR
 01A9 4E        	MOV	C,M
 01AA 23        	INX	H
 01AB 46        	MOV	B,M
                	SBCD	RTCSTR
 01AC+ED43      	DB	0EDH,43H
 01AE+6101      	DW	RTCSTR
                
 01B0 2A5D01    	LHLD	THREAD
 01B3 5E        SU2:	MOV	E,M
 01B4 23        	INX	H	; +1
 01B5 56        	MOV	D,M
 01B6 23        	INX	H	; +2
 01B7 7A        	MOV	A,D
 01B8 B3        	ORA	E
 01B9 CAD501    	JZ	DONE
 01BC D5        	PUSH	D
 01BD 111100    	LXI	D,13H-2	; CHARIO STR IS AT +13H
 01C0 7E        	MOV	A,M
 01C1 FEC8      	CPI	200
                	JRNC	SU3
 01C3+3002      	DB	30H,SU3-$-1
 01C5 1E0E      	MVI	E,10H-2	; DISKIO STR IS AT +10H
 01C7 19        SU3:	DAD	D	;POINT TO STRING ADDRESS
 01C8 5E        	MOV	E,M
 01C9 23        	INX	H
 01CA 56        	MOV	D,M
 01CB CD3202    	CALL	STROUT
 01CE CD1E02    	CALL	CRLF
 01D1 E1        	POP	H
 01D2 C3B301    	JMP	SU2
                DONE:
 01D5 3A6301    	LDA	BIOSPG	; COMPARE PAGE FOR SANITY
 01D8 2A5F01    	LHLD	MEMSTR
 01DB BC        	CMP	H	; SHOULD BE CARRY
 01DC D2E601    	JNC	NOMEM
 01DF EB        	XCHG
 01E0 CD3202    	CALL	STROUT
 01E3 CD1E02    	CALL	CRLF
                NOMEM:
 01E6 3A6301    	LDA	BIOSPG	; COMPARE PAGE FOR SANITY
 01E9 2A6101    	LHLD	RTCSTR
 01EC BC        	CMP	H	; SHOULD BE CARRY
 01ED D2F701    	JNC	NORTC
 01F0 EB        	XCHG
 01F1 CD3202    	CALL	STROUT
 01F4 CD1E02    	CALL	CRLF
                NORTC:
                
                XIT:	LSPD	SAVSTK
 01F7+ED7B      	DB	0EDH,07BH
 01F9+1C02      	DW	SAVSTK
 01FB C9        	RET
                
 01FC           	DS	32
 021C           STACK:	DS	0
                
 021C           SAVSTK: DS	2
                
 021E 3E0D      CRLF:	MVI	A,CR
 0220 CD2502    	CALL	CHROUT
 0223 3E0A      	MVI	A,LF
 0225 C5        CHROUT: PUSH	B
 0226 D5        	PUSH	D
 0227 E5        	PUSH	H
 0228 5F        	MOV	E,A
 0229 0E02      	MVI	C,CONOUT
 022B CD0500    	CALL	BDOS
 022E E1        	POP	H
 022F D1        	POP	D
 0230 C1        	POP	B
 0231 C9        	RET
                
 0232 C5        STROUT: PUSH	B
 0233 E5        	PUSH	H
 0234 0E09      	MVI	C,MSGOUT
 0236 CD0500    	CALL	BDOS
 0239 E1        	POP	H
 023A C1        	POP	B
 023B C9        	RET
                
 023C           	END
